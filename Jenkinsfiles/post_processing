#!groovy
// SPDX-FileCopyrightText: 2022-2023 Technology Innovation Institute (TII)
// SPDX-License-Identifier: Apache-2.0

vulnixJob = ''
sbomJob = ''
vulnsdiffJob = ''
provenanceJob = ''
testJob = ''
level = ''
deviceName = ''

pipeline {
    agent {label "${params.label}"}
    stages {
        stage('Set variables') {
            steps {
                script {
                    def splitted = "${JOB_NAME}".split('/')
                    vulnixJob = "${splitted[0]}/Supply_chain_security/vulnix"
                    sbomJob = "${splitted[0]}/Supply_chain_security/sbomnix"
                    vulnsdiffJob = "${splitted[0]}/Supply_chain_security/vulnsdiff"
                    provenanceJob = "${splitted[0]}/Supply_chain_security/provenance"
                    level = "${splitted[0]}"
                    testJob = "${splitted[0]}/Testing/hw_test_set"
                    currentBuild.description = "${params.server} ${params.device} BuildID: ${params.buildID}"
                }
             }
        }
        stage('vulnix') {
            steps {
                script {
                    build = build(
                        job: "${vulnixJob}", propagate: false,
                        parameters: [
                            [$class: 'StringParameterValue', name: 'outputPath', value: "${params.outputPath}"],
                            [$class: 'StringParameterValue', name: 'buildID', value: "${params.buildID}"],
                            [$class: 'StringParameterValue', name: 'resultsPath', value: "${params.resultsPath}"]
                        ]
                    )
                    if(build.result == "SUCCESS") {
                        echo "BUILD NUMBER: ${build.number} SUCCESSFULLY BUILD"
                    } else {
                        catchError(stageResult: 'FAILURE', buildResult: 'FAILURE') {
                            error("Vulnix build failed")
                        }
                    }
                }
            }
        }
        stage('sbomnix') {
            steps {
                script {
                    build = build(
                        job: "${sbomJob}", propagate: false,
                        parameters: [
                            [$class: 'StringParameterValue', name: 'outputPath', value: "${params.outputPath}"],
                            [$class: 'StringParameterValue', name: 'buildID', value: "${params.buildID}"],
                            [$class: 'StringParameterValue', name: 'resultsPath', value: "${params.resultsPath}"]
                        ]
                    )
                    if(build.result == "SUCCESS") {
                        echo "BUILD NUMBER: ${build.number} SUCCESSFULLY BUILD"
                    } else {
                        catchError(stageResult: 'FAILURE', buildResult: 'FAILURE') {
                            error("sbom build failed")
                        }
                    }
                }
            }
        }
        stage('vulnsdiff') {
            steps {
                script {
                    if ("${params.project}".contains("ghaf-scs-test")) {
                        build = build(
                            job: "${vulnsdiffJob}", propagate: false,
                            parameters: [
                                [$class: 'StringParameterValue', name: 'vulns_csv_baseline_path', value: "${params.vulns_csv_baseline_path}"],
                                [$class: 'StringParameterValue', name: 'buildID', value: "${params.buildID}"],
                                [$class: 'StringParameterValue', name: 'resultsPath', value: "${params.resultsPath}"]
                            ]
                        )
                        if(build.result == "SUCCESS") {
                            echo "BUILD NUMBER: ${build.number} SUCCESSFULLY BUILD"
                        } else {
                            catchError(stageResult: 'FAILURE', buildResult: 'FAILURE') {
                                error("vulnsdiff build failed")
                            }
                        }
                    }
                }
            }
        }
        stage('HW Tests') {
            steps {
                script {
                    if(params.hw_tests) {
                        build = build(
                            job: "${testJob}", propagate: false,
                            parameters: [
                                [$class: 'StringParameterValue', name: 'image', value: "${params.outputPath}/nixos.img"],
                                [$class: 'StringParameterValue', name: 'buildID', value: "${params.buildID}"],
                                [$class: 'StringParameterValue', name: 'resultsPath', value: "${params.resultsPath}"],
                                [$class: 'StringParameterValue', name: 'server', value: "${params.server}"],
                                [$class: 'StringParameterValue', name: 'label', value: "${params.label}"],
                                [$class: 'StringParameterValue', name: 'device', value: "${params.device}"]
                            ]
                        )
                        if(build.result == "SUCCESS") {
                            echo "BUILD NUMBER: ${build.number} SUCCESSFULLY BUILD"
                        } else {
                            catchError(stageResult: 'FAILURE', buildResult: 'FAILURE') {
                                error("${params.device} testset build failed")
                            }
                        }
                    } else {
                        println("No HW tests for this build!")
                    }
                }
            }
        }
        stage('Add post processing timestamp to .json file and create index.html') {
            steps {
                script {
                    sh "python3 addtimestamp/add_timestamp.py ${params.resultsPath}/${params.buildID} ${params.buildID}.json"
                }
            }
        }
        stage('Create index.html and publish reports') {
            steps {
                dir("${params.resultsPath}/"){
                    script {
                        sh "python3 ~/Jenkins-agent/workspace/${level}/post_processing/indexer/indexer.py /files/images/ /webify/build_reports ${params.buildID}"
                        if (params.upload) {
                            def webserver = (params.development) ? "test.vedenemo.dev" : "vedenemo.dev"
                            def sftp_user = (params.development) ? "test_sftp" : "sftp_user"
                            def trigger_user = (params.development) ? "test_trigger" : "script_trigger"
                            sh "scp -s -i ~/.ssh/sftpid_ed25519 -r ${params.buildID} ${sftp_user}@${webserver}:/upload/build_reports/${params.server}/${params.buildID}"
                            sh "ssh -i ~/.ssh/trigid_ed25519 ${trigger_user}@${webserver} -- --index build_reports/${params.server}/${params.buildID}"
                        }
                    }
                }
            }
        }
    }
}
